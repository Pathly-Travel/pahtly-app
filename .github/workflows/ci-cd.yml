name: CI/CD Pipeline

# Trigger de pipeline bij push naar master en bij pull requests
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # Job 1: Testen van de applicatie
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    env:
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: laravel_dto_test
      DB_USERNAME: root
      DB_PASSWORD: password
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: laravel_dto_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7.0
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, redis
          coverage: xdebug

      - name: ğŸ“¦ Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: ğŸ—„ï¸ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: ğŸ“¦ Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install NPM dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build assets
        run: npm run build

      - name: ğŸ“‹ Copy environment file
        run: cp .env.example .env

      - name: ğŸ”‘ Generate application key
        run: php artisan key:generate

      - name: ğŸ—ƒï¸ Run database migrations
        run: php artisan migrate --force

      - name: ğŸŒ± Seed database
        run: php artisan db:seed --force

      - name: ğŸ§ª Run PHP tests
        run: php artisan test 

      # - name: ğŸ”¬ Run PHPStan (static analysis)
      #   run: vendor/bin/phpstan analyse --memory-limit=2G
      #   continue-on-error: true

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # Job 2: Code quality checks
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

      - name: ğŸ“¦ Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: ğŸ¨ Run Laravel Pint (code formatting)
        run: vendor/bin/pint --test

      - name: ğŸ” Run Larastan (PHPStan for Laravel)
        run: vendor/bin/phpstan analyse
        continue-on-error: true

  # Job 3: Security checks
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: ğŸ“¦ Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: ğŸ›¡ï¸ Run security audit
        run: composer audit

      - name: ğŸ” Check for known vulnerabilities
        uses: symfonycorp/security-checker-action@v5

  # Job 4: Build en deployment (alleen bij push naar master)
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, code-quality, security]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://jouw-domein.com
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

      - name: ğŸ“¦ Install Composer dependencies (production)
        run: composer install --optimize-autoloader --no-dev --no-interaction

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install NPM dependencies
        run: npm ci --production

      - name: ğŸ—ï¸ Build production assets
        run: npm run build

      - name: ğŸ“¦ Create deployment package
        run: |
          tar -czf deployment.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.github' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            .

      - name: ğŸ“¤ Upload deployment package
        uses: actions/upload-artifact@v3
        with:
          name: deployment-package
          path: deployment.tar.gz

      - name: ğŸš€ Deploy to server
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SSH_PORT }}
          script: |
            # Variabelen
            APP_DIR="/var/www/laravel-dto"
            BACKUP_DIR="/var/backups/laravel-dto"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Maak backup van huidige versie
            echo "ğŸ—„ï¸ Creating backup..."
            sudo mkdir -p $BACKUP_DIR
            sudo cp -r $APP_DIR $BACKUP_DIR/backup_$TIMESTAMP
            
            # Ga naar applicatie directory
            cd $APP_DIR
            
            # Pull laatste code
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin master
            
            # Installeer dependencies
            echo "ğŸ“¦ Installing dependencies..."
            composer install --optimize-autoloader --no-dev --no-interaction
            npm ci --production
            npm run build
            
            # Laravel optimalisaties
            echo "âš¡ Optimizing Laravel..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan event:cache
            
            # Database migraties
            echo "ğŸ—ƒï¸ Running migrations..."
            php artisan migrate --force
            
            # Cache legen
            echo "ğŸ§¹ Clearing caches..."
            php artisan cache:clear
            php artisan queue:restart
            
            # Permissies instellen
            echo "ğŸ” Setting permissions..."
            sudo chown -R www-data:www-data $APP_DIR
            sudo chmod -R 755 $APP_DIR/storage
            sudo chmod -R 755 $APP_DIR/bootstrap/cache
            
            # Services herstarten
            echo "ğŸ”„ Restarting services..."
            sudo systemctl reload nginx
            sudo systemctl restart php8.2-fpm
            sudo supervisorctl restart laravel-queue-worker:*
            
            # Health check
            echo "ğŸ¥ Running health check..."
            curl -f http://localhost/health-check || exit 1
            
            echo "âœ… Deployment completed successfully!"

      # - name: ğŸ“¢ Notify deployment success
      #   if: success()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: success
      #     text: "ğŸš€ Production deployment successful!"
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # - name: ğŸ“¢ Notify deployment failure
      #   if: failure()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: failure
      #     text: "âŒ Production deployment failed!"
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # # Job 5: Notification (altijd uitvoeren)
  # notify:
  #   name: ğŸ“¢ Notifications
  #   runs-on: ubuntu-latest
  #   needs: [test, code-quality, security]
  #   if: always()
    
  #   steps:
  #     - name: ğŸ“¢ Send Slack notification
  #       uses: 8398a7/action-slack@v3
  #       with:
  #         status: ${{ job.status }}
  #         fields: repo,message,commit,author,action,eventName,ref,workflow
  #       env:
  #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 